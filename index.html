<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å»£å³¶äº”å¤©å››å¤œ (é›¢ç·šå¯ç·¨è¼¯ç‰ˆ)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f9fafb;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
        }

        /* Scrollbar éš±è— */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ‰å¹³åŒ–å¡ç‰‡æ¨£å¼ */
        .flat-card {
            border: 1px solid #e5e7eb;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s;
        }
        
        /* ç·¨è¼¯æç¤º (é•·æŒ‰æ•ˆæœ) */
        .editable-card:hover {
             box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
        }
        .editable-card:active {
             box-shadow: 0 2px 5px rgba(37, 99, 235, 0.4);
             transform: scale(0.99);
        }
        .editable-card::after {
            content: 'é•·æŒ‰/å³éµç·¨è¼¯';
            position: absolute;
            top: 0;
            right: 0;
            background-color: #bfdbfe;
            color: #1e40af;
            padding: 2px 6px;
            border-bottom-left-radius: 8px;
            border-top-right-radius: 12px;
            font-size: 0.6rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .editable-card:hover::after {
            opacity: 1;
        }


        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-line {
            position: absolute; left: 5px; top: 24px; bottom: -24px;
            width: 2px; background-color: #e5e7eb; z-index: 0;
        }
        .timeline-item:last-child .timeline-line { display: none; }

        /* Modal æ¨£å¼ (Slide-Up) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: flex; align-items: flex-end; justify-content: center; padding: 0;
        }

        .modal-content {
            background-color: #ffffff; width: 100%; max-width: 500px; max-height: 90vh;
            border-top-left-radius: 16px; border-top-right-radius: 16px; overflow-y: auto;
            padding: 24px; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15); position: relative;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }

        .modal.is-open .modal-content { transform: translateY(0); }

        .modal-content a { color: #2563eb; text-decoration: underline; }

        /* Logistical List Style */
        .logistics-list {
            white-space: pre-wrap; font-size: 0.875rem; color: #4b5563; line-height: 1.5;
            background-color: #f9fafb; padding: 10px; border-radius: 8px; margin-top: 8px;
            border: 1px solid #e5e7eb;
        }
        
        /* åº•éƒ¨å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .nav-btn { color: #9ca3af; transition: all 0.2s; }
        .nav-btn.active { color: #2563eb; }
        .nav-btn.active .nav-icon { fill: currentColor; transform: scale(1.1); }
        
        /* Day æŒ‰éˆ•æ¨£å¼ */
        .day-tab-btn.active { background-color: #dbeafe; color: #1e40af; font-weight: 700; border: 1px solid #bfdbfe; }
        .day-tab-btn.inactive { background-color: #ffffff; color: #6b7280; border: 1px solid #f3f4f6; }
    </style>
</head>
<body>

    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="relative w-full bg-white z-20 px-4 py-6 text-center mb-2">
        <h1 class="text-2xl font-bold tracking-wide text-gray-800">å»£å³¶ä¹‹æ—…</h1>
        <p class="text-xs text-gray-400 mt-1">Hiroshima 5 Days Trip</p>
    </header>

    <!-- å…§å®¹å®¹å™¨ -->
    <div class="max-w-md mx-auto relative min-h-screen">

        <!-- 1. è¡Œç¨‹é é¢ (Itinerary) -->
        <main id="view-itinerary" class="tab-view px-4">
            
            <!-- æ—¥æœŸåˆ‡æ› Tabs (Sticky: é»åœ¨é ‚éƒ¨) -->
            <div class="sticky top-0 z-40 bg-gray-50/95 backdrop-blur-sm pt-2 pb-4 -mx-4 px-4 border-b border-gray-200 shadow-sm">
                <div class="flex justify-between items-center gap-2" id="day-tabs-container">
                    <!-- ç”± JS ç”ŸæˆæŒ‰éˆ• -->
                </div>
            </div>

            <!-- è¡Œç¨‹å…§å®¹å€ -->
            <div id="day-content-container" class="mt-6">
                <!-- ç”± JS ç”Ÿæˆå…§å®¹ -->
            </div>
        </main>

        <!-- 2. è³‡è¨Šé é¢ (Info) -->
        <main id="view-info" class="tab-view hidden px-4 pt-6 space-y-6">
            
            <div class="flat-card p-5">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center text-lg">
                    <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded mr-2 text-xs font-bold">FLIGHT</span> èˆªç­è³‡è¨Š
                </h3>
                <div class="space-y-6">
                    <div class="flex justify-between items-center border-b border-gray-100 pb-4">
                        <div class="w-full">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-gray-400 text-xs font-medium bg-gray-100 px-2 py-0.5 rounded">å»ç¨‹ 12/5</span>
                                <span class="text-xs text-gray-400">CI 112</span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-center">
                                    <span class="block text-2xl font-bold text-gray-800">07:00</span>
                                    <span class="text-xs font-bold text-gray-500">TPE</span>
                                </div>
                                <div class="flex-1 px-4 flex flex-col items-center">
                                    <span class="text-gray-300 text-xs mb-1">2h 15m</span>
                                    <div class="w-full h-px bg-gray-300 relative">
                                        <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-1 h-1 bg-gray-300 rounded-full"></div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <span class="block text-2xl font-bold text-gray-800">10:15</span>
                                    <span class="text-xs font-bold text-gray-500">HIJ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="w-full">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-gray-400 text-xs font-medium bg-gray-100 px-2 py-0.5 rounded">å›ç¨‹ 12/9</span>
                                <span class="text-xs text-gray-400">CI 113</span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-center">
                                    <span class="block text-2xl font-bold text-gray-800">11:15</span>
                                    <span class="text-xs font-bold text-gray-500">HIJ</span>
                                </div>
                                <div class="flex-1 px-4 flex flex-col items-center">
                                    <span class="text-gray-300 text-xs mb-1">2h 55m</span>
                                    <div class="w-full h-px bg-gray-300 relative">
                                        <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-1 h-1 bg-gray-300 rounded-full"></div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <span class="block text-2xl font-bold text-gray-800">13:10</span>
                                    <span class="text-xs font-bold text-gray-500">TPE</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flat-card p-5">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center text-lg">
                    <span class="bg-indigo-100 text-indigo-600 px-2 py-1 rounded mr-2 text-xs font-bold">HOTEL</span> ä½å®¿è³‡è¨Š
                </h3>
                <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-100">
                    <p class="font-bold text-gray-800 text-lg">æ±æ©«INN </p>
                    <p class="text-xs text-gray-500 mt-1 font-mono">Toyoko Inn Hiroshima Ekimae Ohashi Minami</p>
                    <div class="mt-3 flex gap-2">
                        <span class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500">Check-in 15:00</span>
                        <span class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500">å«æ—©é¤</span>
                    </div>
                </div>
                <a href="https://maps.app.goo.gl/t1k5Qv5FmQ2J7FwD8" target="_blank" class="flex items-center justify-center w-full bg-blue-600 text-white py-3 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-700 transition">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                    é–‹å•Ÿ Google Map å°èˆª
                </a>
            </div>
        </main>

        <!-- 3. æº–å‚™é é¢ (Prep) -->
        <main id="view-prep" class="tab-view hidden px-4 pt-6 space-y-6">
            
            <div class="flat-card p-5 border-l-4 border-red-500 relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2">
                    <svg class="w-24 h-24 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </div>
                <h3 class="font-bold text-gray-800 mb-4 text-lg">ç·Šæ€¥è¯çµ¡</h3>
                <div class="grid grid-cols-2 gap-3 text-sm relative z-10">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-gray-400 text-xs mb-1">è­¦å¯Ÿ (Police)</span>
                        <a href="tel:110" class="font-mono font-bold text-xl text-gray-800">110</a>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-gray-400 text-xs mb-1">æ•‘è­·/ç«è­¦ (Fire)</span>
                        <a href="tel:119" class="font-mono font-bold text-xl text-gray-800">119</a>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg border border-red-100 col-span-2">
                        <span class="block text-red-400 text-xs mb-1">é§å¤§é˜ªè¾¦äº‹è™• (ç·Šæ€¥)</span>
                        <a href="tel:+819087944568" class="font-mono font-bold text-xl text-red-600">090-8794-4568</a>
                    </div>
                </div>
            </div>

            <div class="flat-card p-5">
                <h3 class="font-bold text-gray-800 mb-4 text-lg">è¡Œææ¸…å–® Check</h3>
                <ul class="space-y-3">
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c1" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c1" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">è­·ç…§ (æœ‰æ•ˆæœŸé™å…§)</label>
                    </li>
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c2" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c2" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">Visit Japan Web QR Code</label>
                    </li>
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c3" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c3" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡ / äº¤é€šå¡</label>
                    </li>
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c4" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c4" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">ç¶²å¡ / Wi-Fi æ©Ÿ</label>
                    </li>
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c5" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c5" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">è¡Œå‹•é›»æº / å……é›»ç·š</label>
                    </li>
                    <li class="flex items-center group cursor-pointer">
                        <input type="checkbox" id="c6" class="peer w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <label for="c6" class="ml-3 text-sm text-gray-600 peer-checked:text-gray-400 peer-checked:line-through cursor-pointer select-none">è½‰æ¥é ­ (æ—¥æœ¬é›™å­”æ‰æ’)</label>
                    </li>
                </ul>
                <button onclick="localStorage.removeItem('user_itinerary_edits'); location.reload();" class="mt-4 text-xs text-red-500 hover:text-red-700 transition">
                    æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç·¨è¼¯è¨˜éŒ„
                </button>
            </div>
        </main>

         <!-- 4. æŒ‡å—é é¢ (Guide) -->
        <main id="view-guide" class="tab-view hidden px-4 pt-6 space-y-6">
            <!-- è³¼ç‰©æŒ‡å— -->
             <div class="flat-card overflow-hidden">
                <div class="bg-gradient-to-r from-orange-50 to-white p-4 border-b border-orange-100">
                    <h3 class="font-bold text-orange-800 text-lg">å¿…è²·ä¼´æ‰‹ç¦®</h3>
                </div>
                <div class="p-5 text-sm space-y-4">
                    <div class="flex items-start">
                        <span class="flex-shrink-0 bg-orange-100 text-orange-600 rounded-lg w-8 h-8 flex items-center justify-center font-bold text-sm mr-3">1</span>
                        <div><strong class="text-gray-800 text-base block mb-1">ç´…è‘‰é¥…é ­</strong><span class="text-gray-500 leading-relaxed">å»£å³¶æœ€ç¶“å…¸ä¼´æ‰‹ç¦®ï¼Œé™¤äº†ç´…è±†é¤¡ï¼Œé‚„æœ‰å¥¶æ²¹ã€å·§å…‹åŠ›ç”šè‡³ç‚¸ç´…è‘‰é¥…é ­ç­‰å¤šç¨®åƒæ³•ã€‚</span></div>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 bg-orange-100 text-orange-600 rounded-lg w-8 h-8 flex items-center justify-center font-bold text-sm mr-3">2</span>
                        <div><strong class="text-gray-800 text-base block mb-1">ç€¨æˆ¶å…§æª¸æª¬è›‹ç³•</strong><span class="text-gray-500 leading-relaxed">å»£å³¶æ˜¯æ—¥æœ¬æª¸æª¬ç”¢é‡ç¬¬ä¸€ï¼Œæª¸æª¬è›‹ç³•é…¸ç”œæ¸…çˆ½ï¼Œå¤–å‹å¯æ„›ï¼Œéå¸¸é©åˆé€ç¦®ã€‚</span></div>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 bg-orange-100 text-orange-600 rounded-lg w-8 h-8 flex items-center justify-center font-bold text-sm mr-3">3</span>
                        <div><strong class="text-gray-800 text-base block mb-1">ç‰¡è £é†¬æ²¹æµ·è‹”</strong><span class="text-gray-500 leading-relaxed">å»£å³¶ç‰¡è £ç²¾è¯æ¿ƒç¸®åœ¨æµ·è‹”ä¸­ï¼Œé®®å‘³åè¶³ï¼Œæ˜¯æ­é…ç™½é£¯çš„ç¥ç‰©ã€‚</span></div>
                    </div>
                </div>
            </div>

            <!-- è¡£è‘—å»ºè­° -->
             <div class="flat-card overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-white p-4 border-b border-blue-100">
                    <h3 class="font-bold text-blue-800 text-lg">12æœˆè¡£è‘—å»ºè­°</h3>
                </div>
                <div class="p-5 text-sm text-gray-600">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">ğŸŒ¡ï¸</span>
                        <span class="font-medium">å¹³å‡æ°£æº« 5Â°C ~ 12Â°C</span>
                    </div>
                    <ul class="list-disc pl-5 mt-2 space-y-2 leading-relaxed">
                        <li><strong>æ´‹è”¥å¼ç©¿æ­ï¼š</strong>æ—¥æœ¬å®¤å…§ã€é›»è»Šæš–æ°£å¾ˆå¼·ï¼Œå»ºè­°å…§ç©¿ç™¼ç†±è¡£+æ¯›è¡£ï¼Œå¤–æ­ä¸€ä»¶é˜²é¢¨ä¿æš–å¥½ç©¿è„«çš„å¤§è¡£æˆ–ç¾½çµ¨å¤–å¥—ã€‚</li>
                        <li><strong>é˜²é¢¨é…ä»¶ï¼šï¼š</strong>å®®å³¶ã€å°¾é“ç­‰æµ·é‚Šæ™¯é»é¢¨å¤§é«”æ„Ÿæº«åº¦ä½ï¼Œå‹™å¿…æ”œå¸¶åœå·¾ã€æ¯›å¸½æˆ–è€³ç½©ã€‚</li>
                        <li><strong>å¥½èµ°çš„é‹ï¼šï¼š</strong>æœ¬æ¬¡è¡Œç¨‹åŒ…å«ç¥ç¤¾ã€çˆ¬å¡(å°¾é“)ï¼Œè«‹å‹™å¿…ç©¿è‘—èˆ’é©å¥½èµ°çš„çƒé‹ã€‚</li>
                    </ul>
                </div>
            </div>
        </main>

    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center pb- safe-area-bottom z-30 h-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button class="nav-btn active flex flex-col items-center justify-center w-full h-full" onclick="switchMainTab('itinerary')">
            <svg class="w-6 h-6 mb-1 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            <span class="text-[10px] font-bold">è¡Œç¨‹</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center w-full h-full" onclick="switchMainTab('info')">
            <svg class="w-6 h-6 mb-1 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[10px] font-bold">è³‡è¨Š</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center w-full h-full" onclick="switchMainTab('prep')">
            <svg class="w-6 h-6 mb-1 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[10px] font-bold">æº–å‚™</span>
        </button>
        <button class="nav-btn flex flex-col items-center justify-center w-full h-full" onclick="switchMainTab('guide')">
            <svg class="w-6 h-6 mb-1 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
            <span class="text-[10px] font-bold">æŒ‡å—</span>
        </button>
    </nav>

    <!-- æ™¯é»ä»‹ç´¹ Modal è¦–çª— (ç”¨æ–¼é–±è®€è©³ç´°å…§å®¹) -->
    <div id="details-modal" class="modal hidden" onclick="closeModal('details-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2"></h3>
            <div id="modal-body" class="text-sm text-gray-700 leading-relaxed space-y-4">
                <!-- å…§å®¹ç”± JS å¡«å…… -->
            </div>
            <button onclick="closeModal('details-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full bg-gray-50 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- ç·¨è¼¯ Modal è¦–çª— (ç”¨æ–¼ä¿®æ”¹è¡Œç¨‹å…§å®¹) -->
    <div id="edit-modal" class="modal hidden" onclick="closeModal('edit-modal')">
        <form class="modal-content" onclick="event.stopPropagation()" onsubmit="saveEdit(event)">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç·¨è¼¯è¡Œç¨‹é …ç›®</h3>
            
            <input type="hidden" id="edit-day-index">
            <input type="hidden" id="edit-event-index">
            <input type="hidden" id="edit-item-index">

            <div class="mb-4">
                <label for="edit-time" class="block text-xs font-bold text-gray-500 mb-1">æ™‚é–“ (Time)</label>
                <input type="text" id="edit-time" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚: 10:00">
            </div>

            <div class="mb-4">
                <label for="edit-title" class="block text-xs font-bold text-gray-500 mb-1">æ¨™é¡Œ (Title)</label>
                <input type="text" id="edit-title" required class="w-full border border-gray-300 rounded-lg p-3 text-sm font-semibold focus:ring-blue-500 focus:border-blue-500" placeholder="æ™¯é»æˆ–æ´»å‹•åç¨±">
            </div>

            <div class="mb-6">
                <label for="edit-desc" class="block text-xs font-bold text-gray-500 mb-1">è©³ç´°èªªæ˜/å‚™è¨» (Description/Details)</label>
                <textarea id="edit-desc" rows="6" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="äº¤é€šã€å‚™è¨»ã€ç´°ç¯€ã€åœ°åœ–é€£çµç­‰ (å¯å¤šè¡Œ)"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('edit-modal')" class="bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">
                    å–æ¶ˆ
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-500/50">
                    å„²å­˜ä¿®æ”¹
                </button>
            </div>

            <button type="button" onclick="closeModal('edit-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2 rounded-full bg-gray-50 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </form>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™èˆ‡ LocalStorage è™•ç† ---

        // åŸå§‹è¡Œç¨‹è³‡æ–™ (å‚™ä»½)
        const originalItineraryData = [
            {
                day: 1, dayLabel: 'D1', date: '12/5', location: 'å»£å³¶å¸‚å€',
                events: [
                    { time: '02:30', title: 'äº¤é€šï¼šæ©Ÿå ´æ¥é€', type: 'transport', desc: 'æ±æ­¢ â†’ æ¡ƒåœ’æ©Ÿå ´', uniqueId: 'd1e1' },
                    { time: '03:50', title: 'æ¡ƒåœ’æ©Ÿå ´ ç¬¬2èˆªå»ˆ', type: 'misc', desc: 'Check-in / å‡ºå¢ƒæ‰‹çºŒ', uniqueId: 'd1e2' },
                    { time: '07:00', end: '10:15', title: 'èˆªç­ CI112', type: 'transport', desc: 'TPE â†’ HIJ', uniqueId: 'd1e3' },
                    { time: '10:15', title: 'å»£å³¶æ©Ÿå ´', type: 'misc', desc: 'å…¥å¢ƒæ‰‹çºŒ', uniqueId: 'd1e4' },
                    { 
                        time: '10:40', 
                        title: 'ã€æ©Ÿå ´å·´å£«ã€‘å»£å³¶ç©ºæ¸¯ â†’ å»£å³¶é§…æ–°å¹¹ç·šå£', 
                        type: 'transport', 
                        desc: 'ğŸšŒ ä¹˜è»Šåœ°é»ï¼šå»£å³¶æ©Ÿå ´å·´å£«ã€2è™Ÿæœˆå°ã€‘\nğŸ’° ç¥¨åƒ¹ï¼šÂ¥1500\nâ³ ç­æ¬¡ï¼šç´„15åˆ†ä¸€ç­\nğŸ’¡ å‚™è¨»ï¼šå‰é–€ä¸Šè»Š',
                        uniqueId: 'd1e5'
                    },
                    { time: '11:30', title: 'å»£å³¶é§…æ–°å¹¹ç·šå£', type: 'misc', desc: 'æŠµé”å»£å³¶è»Šç«™', uniqueId: 'd1e6' },
                    { 
                        time: '11:45', 
                        title: 'åˆé¤ï¼šå»£å³¶è»Šç«™', 
                        type: 'meal', 
                        desc: 'ğŸ“ åœ°é»ï¼šminamoa / ekie\n1F å°¾é“æ‹‰éºµ\n2F SOUP CURRY KING æ¹¯å’–å“©\n6F å™ã€…è‹‘ (ç‡’è‚‰) ğŸ•™ 11:00-22:00\n6F ç‚­ç„¼ç‰›ãŸã‚“æ±å±± é›… (ä»™å°ç‰›èˆŒ) ğŸ•™ 11:00-22:00',
                        uniqueId: 'd1e7'
                    },
                    { 
                        time: '13:10', 
                        title: 'å»£å³¶è»Šç«™å‘¨é‚Šè³¼ç‰©', 
                        type: 'misc', 
                        desc: 'ekie 2F å¯¶å¯å¤¢ä¸­å¿ƒ\nminamoa 2F åŒ—æ˜Ÿå·´å…‹\nminamoa 4F 3COINS',
                        uniqueId: 'd1e8'
                    },
                    { time: '14:45', title: 'äº¤é€šï¼šæ­¥è¡Œ', type: 'transport', desc: 'å¾€æ±æ©«INNæ–¹å‘ (ç´„7åˆ†é˜)', uniqueId: 'd1e9' },
                    { time: '15:00', title: 'Check-in', type: 'hotel', desc: 'æ±æ©«INN ', uniqueId: 'd1e10' },
                    { 
                        time: '15:30', 
                        title: 'äº¤é€šï¼šå‰å¾€å’Œå¹³å…¬åœ’', 
                        type: 'transport', 
                        desc: 'ğŸšŒ å…¬è»Š 24/25 æˆ– å»£é›»å‰å¾€å’Œå¹³ç´€å¿µå…¬åœ’å‘¨é‚Šã€‚\nğŸ’° è»Šè³‡ï¼šÂ¥240\nè·¯ç·šé¸æ“‡ï¼š\nã€‚å…¬è»Š24ï¼šå»£å³¶ç«™ 6è™Ÿæœˆå° â†’ å’Œå¹³ç´€å¿µå…¬åœ’ (23åˆ†)\nã€‚å…¬è»Š25ï¼šç¨»è·ç”ºï¼ˆå»£å³¶ï¼‰2è™Ÿæœˆå° â†’ å’Œå¹³ç´€å¿µå…¬åœ’ (20åˆ†)\nã€‚å»£é›»ï¼šç¨»è·ç”ºï¼ˆå»£å³¶ï¼‰ â†’ è¢‹ç”º (24åˆ†)',
                        uniqueId: 'd1e11'
                    },
                    { 
                        time: '16:00', 
                        title: 'å»£å³¶å’Œå¹³å…¬åœ’', 
                        type: 'spot',
                        uniqueId: 'd1e12', // æ™¯é»äº‹ä»¶æœ¬èº«
                        items: [
                            { 
                                name: 'å»£å³¶å’Œå¹³ç´€å¿µè³‡æ–™é¤¨', 
                                mapQuery: 'å»£å³¶å’Œå¹³ç´€å¿µè³‡æ–™é¤¨',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šæˆäººÂ¥200 / 65æ­²ä»¥ä¸ŠÂ¥100\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š7:30 - 18:00\nğŸ’¡ å‚™è¨»ï¼š12æœˆè‡³2æœˆç‰¹å®šæ™‚æ®µéœ€åœ¨ç·šè³¼ç¥¨ï¼Œå”®ç¥¨è‡³16:30',
                                details: 'ç”±ä¸¹ä¸‹å¥ä¸‰è¨­è¨ˆï¼Œå±•ç¤ºäº†åŸçˆ†çš„æ…˜ç—›æ­·å²èˆ‡éºç‰©ï¼Œç›®çš„æ˜¯å‘ä¸–äººå‚³é”æ ¸æ­¦çš„å¯æ€•ä¸¦ç¥ˆæ±‚ä¸–ç•Œå’Œå¹³ã€‚é¤¨å…§å±•ç¤ºå…§å®¹éœ‡æ’¼äººå¿ƒï¼Œæ˜¯å»£å³¶æœ€é‡è¦çš„æ­·å²å ´æ‰€ã€‚',
                                uniqueId: 'd1e12i1' // æ™¯é»å­é …ç›®
                            },
                            { 
                                name: 'å»£å³¶åŸçˆ†åœ“é ‚é¤¨', 
                                mapQuery: 'åŸçˆ†åœ“é ‚é¤¨',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²» (å®¤å¤–æ™¯é»)\nğŸ•™ é»ç‡ˆæ™‚é–“ï¼š20:00 è‡³ 0:00\nğŸŒ ARé€£çµ: https://peace-tourism.com/description.html\nğŸ’¡ å‚™è¨»ï¼š1996å¹´12æœˆç™»éŒ„ç‚ºä¸–ç•Œéºç”¢ã€‚',
                                details: 'å‰èº«ç‚ºå»£å³¶ç¸£ç”¢æ¥­çå‹µé¤¨ï¼Œæ˜¯å°‘æ•¸åœ¨åŸçˆ†ä¸­å¿ƒé™„è¿‘æ²’æœ‰å®Œå…¨å€’å¡Œçš„å»ºç¯‰ã€‚å®ƒä¿ç•™äº†ç•¶æ™‚è¢«è½Ÿç‚¸å¾Œçš„æ®˜ç ´åŸè²Œï¼Œä½œç‚ºä¸–ç•Œæ–‡åŒ–éºç”¢ï¼Œç„¡è²åœ°è¨´èªªè‘—æˆ°çˆ­çš„æ®˜é…·ã€‚' ,
                                uniqueId: 'd1e12i2'
                            },
                            { 
                                name: 'å’Œå¹³ç´€å¿µå…¬åœ’', 
                                mapQuery: 'å»£å³¶å’Œå¹³ç´€å¿µå…¬åœ’',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²» (æˆ¶å¤–ç©ºé–“)\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼šå…¨å¤©é–‹æ”¾',
                                details: 'ä½æ–¼å…ƒå®‰å·èˆ‡æœ¬å·ä¹‹é–“çš„æ²™æ´²ä¸Šï¼Œåœ’å…§æœ‰è¨±å¤šç´€å¿µç¢‘ï¼ŒåŒ…æ‹¬ã€ŒåŸçˆ†æ­»æ²¡è€…æ…°éˆç¢‘ã€èˆ‡ã€Œå’Œå¹³ä¹‹é˜ã€ï¼Œæ˜¯å¸‚æ°‘ä¼‘æ†©èˆ‡ç¥ˆç¦±å’Œå¹³çš„è–åœ°ã€‚',
                                uniqueId: 'd1e12i3'
                            }
                        ]
                    },
                    { time: '18:30', title: 'æ™šé¤ï¼šæ¾å±‹', type: 'meal', desc: 'å»£å³¶æœ¬é€šå•†åº—è¡—é™„è¿‘ï¼Œæˆ–è‡ªç”±é¸æ“‡', uniqueId: 'd1e13' },
                    { 
                        time: '19:30', 
                        title: 'å»£å³¶æœ¬é€šå•†åº—è¡—', 
                        type: 'misc', 
                        desc: 'LOFTã€Seria ğŸ•™ 10:00â€“19:30\nå¤§å‰µã€UNIQLO ğŸ•™ 10:30â€“20:00\nPARCO ğŸ•™ 10:00â€“20:30\nå”å‰è»»å¾· ğŸ•™ 10:00â€“05:00',
                        uniqueId: 'd1e14'
                    },
                    { 
                        time: '20:30', 
                        title: 'äº¤é€šï¼šè¿”å›é£¯åº—', 
                        type: 'transport', 
                        desc: 'ğŸ’° è»Šè³‡ï¼šÂ¥240\nè·¯ç·šé¸æ“‡ï¼š\nã€‚å»£é›»ï¼šå…«ä¸å €ï¼ˆå»£å³¶ï¼‰â†’ç¨»è·ç”ºï¼ˆå»£å³¶ï¼‰ï¼Œå†æ­¥è¡Œ4åˆ† (12åˆ†)\nã€‚å…¬è»Šï¼šå…«ä¸å €â†’å»£å³¶ç«™ï¼Œå†æ­¥è¡Œ4åˆ† (13åˆ†)',
                        uniqueId: 'd1e15'
                    },
                ]
            },
            {
                day: 2, dayLabel: 'D2', date: '12/6', location: 'å»£å³¶/å³å¸‚',
                events: [
                    { 
                        time: '09:00', 
                        title: 'å»£å³¶åŸåŠå‘¨é‚Š', 
                        type: 'spot',
                        uniqueId: 'd2e1',
                        items: [
                            { 
                                name: 'å»£å³¶åŸ (é¯‰åŸ)', 
                                mapQuery: 'å»£å³¶åŸ',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå¤©å®ˆé–£ Â¥370\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š9:00 - 17:00 (12/10-3/31)',
                                details: 'åˆ¥åã€Œé¯‰åŸã€ï¼Œç”±æ¯›åˆ©è¼å…ƒå»ºæ–¼1589å¹´ã€‚é›–ç„¶å¤©å®ˆé–£åœ¨åŸçˆ†ä¸­å€’å¡Œï¼Œä½†å¾Œä¾†ä»¥é‹¼ç­‹æ··å‡åœŸé‡å»ºã€‚ç¾åœ¨å…§éƒ¨æ˜¯ä»‹ç´¹æ­¦å®¶æ–‡åŒ–çš„æ­·å²åšç‰©é¤¨ï¼Œé ‚æ¨“å¯çœºæœ›å¸‚å€ã€‚',
                                uniqueId: 'd2e1i1'
                            },
                            { 
                                name: 'å»£å³¶è­·åœ‹ç¥ç¤¾', 
                                mapQuery: 'å»£å³¶è­·åœ‹ç¥ç¤¾',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼šå…¨å¤©é–‹æ”¾',
                                details: 'ä½æ–¼å»£å³¶åŸå…§ï¼Œæ˜¯å»£å³¶é¯‰é­šéšŠæ¯å¹´å¿…ä¾†ç¥ˆæ±‚å‹åˆ©çš„ç¥ç¤¾ï¼Œå› æ­¤ä»¥ã€Œé¯‰é­šå¾¡å®ˆã€èåï¼Œä¹Ÿæ˜¯ç•¶åœ°æ–°å¹´åƒæ‹œäººæ•¸æœ€å¤šçš„ç¥ç¤¾ã€‚',
                                uniqueId: 'd2e1i2'
                            }
                        ]
                    },
                    { time: '11:45', title: 'åˆé¤ï¼šå»£å³¶è»Šç«™ 6F', type: 'meal', desc: 'ç‚­ç„¼ç‰›ãŸã‚“æ±å±± é›… (ä»™å°ç‰›èˆŒ)', uniqueId: 'd2e2' },
                    { 
                        time: '13:00', 
                        title: 'äº¤é€šï¼šJRå±±é™½æœ¬ç·š â†’ å³å¸‚', 
                        type: 'transport', 
                        desc: 'ç´„30åˆ†é˜ï¼Œä¸‹è»Šå¾Œå»ºè­°å…ˆç¢ºèªå³ç£èˆ¹è‰¦å¤•é™½èˆ¹ç­å ±åç‹€æ³',
                        uniqueId: 'd2e3' 
                    },
                    { 
                        time: '14:00', 
                        title: 'å³å¸‚åšç‰©é¤¨ç¾¤', 
                        type: 'spot',
                        uniqueId: 'd2e4',
                        items: [
                            { 
                                name: 'å¤§å’Œåšç‰©é¤¨', 
                                mapQuery: 'å¤§å’Œåšç‰©é¤¨',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šÂ¥500\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š9:00 - 18:00 (é€±äºŒä¼‘é¤¨)',
                                details: 'å³å¸‚æ›¾æ˜¯æ±æ´‹ç¬¬ä¸€è»æ¸¯ã€‚é¤¨å…§å±•ç¤ºäº†é®é¤¨ä¹‹å¯¶ï¼šå…¨é•·26.3å…¬å°ºçš„ã€Œ1/10 æˆ°è‰¦å¤§å’Œè™Ÿã€æ¨¡å‹ï¼Œç´°ç¯€ç²¾ç·»é€¼çœŸï¼Œè®“äººæ„Ÿå—åˆ°ç•¶æ™‚é€ èˆ¹æŠ€è¡“çš„å®å‰ã€‚',
                                uniqueId: 'd2e4i1'
                            },
                            { 
                                name: 'æµ·ä¸Šè‡ªè¡›éšŠå³å²æ–™é¤¨ (éµé¯¨é¤¨)', 
                                mapQuery: 'æµ·ä¸Šè‡ªè¡›éšŠå³å²æ–™é¤¨',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š9:00 - 17:00 (é€±äºŒä¼‘é¤¨)',
                                details: 'åˆ¥åã€Œéµé¯¨é¤¨ã€ï¼Œæ˜¯æ—¥æœ¬å”¯ä¸€å±•ç¤ºçœŸå¯¦é€€å½¹æ½›æ°´è‰‡ï¼ˆç§‹æ½®è™Ÿï¼‰çš„åšç‰©é¤¨ã€‚æ‚¨å¯ä»¥å¯¦éš›é€²å…¥æ½›æ°´è‰‡å…§éƒ¨åƒè§€ï¼Œé«”é©—èˆ¹å“¡çš„ç”Ÿæ´»ç©ºé–“ï¼Œéå¸¸é›£å¾—ï¼',
                                uniqueId: 'd2e4i2'
                            }
                        ]
                    },
                    { 
                        time: '17:00', 
                        title: 'å³ç£èˆ¹è‰¦å·¡ç¦®', 
                        type: 'spot', 
                        uniqueId: 'd2e5',
                        items: [{
                            name: 'å³ç£èˆ¹è‰¦å·¡ç¦®',
                            mapQuery: 'å³ç£è‰¦èˆ¹ã‚ãã‚Š',
                            logistics: 'ğŸ’° èˆ¹ç¥¨ï¼šÂ¥1500 (è¦–èˆ¹ç­è€Œå®š)\nğŸ•™ å¤•é™½èˆªç­ï¼šç´„16:00 (éœ€é å…ˆç¢ºèª)',
                            details: 'æ­ä¹˜éŠè¦½èˆ¹å¾æµ·ä¸Šè¿‘è·é›¢è§€çœ‹æµ·ä¸Šè‡ªè¡›éšŠçš„ç¾å½¹æ½›æ°´è‰‡èˆ‡è­·è¡›è‰¦ï¼Œé­„åŠ›åè¶³ã€‚è‹¥åƒåŠ å¤•é™½èˆªç­ï¼Œé‚„æœ‰æ©Ÿæœƒçœ‹åˆ°è‡ªè¡›è‰¦é™æ——å„€å¼ï¼ˆãƒ©ãƒƒãƒ‘æ¼”å¥ï¼‰ã€‚',
                            uniqueId: 'd2e5i1'
                        }]
                    },
                    { 
                        time: '18:00', 
                        title: 'æ™šé¤/è³¼ç‰© (Youme Town å³åº—)', 
                        type: 'meal', 
                        desc: 'ğŸ´ æ™šé¤ï¼šå®šé£Ÿå±‹ç™¾èœæ—¬ (3F)\nğŸ›ï¸ è³¼ç‰©ï¼šUniqloã€Seria (1-2F)',
                        uniqueId: 'd2e6'
                    },
                    { time: '20:00', title: 'äº¤é€šï¼šJRå±±é™½æœ¬ç·š â†’ å»£å³¶', type: 'transport', desc: 'è¿”å›å»£å³¶å¸‚å€', uniqueId: 'd2e7' }
                ]
            },
            {
                day: 3, dayLabel: 'D3', date: '12/7', location: 'å°¾é“/ä¸‰åŸ',
                events: [
                    { time: '08:48', title: 'äº¤é€šï¼šå±±é™½æœ¬ç·š å»£å³¶ â†’ å°¾é“', type: 'transport', desc: 'ç´„1å°æ™‚40åˆ†', uniqueId: 'd3e1' },
                    { time: '10:45', title: 'å°¾é“æœ¬é€šå•†åº—è¡—', type: 'misc', desc: 'æ„Ÿå—æ‡·èˆŠæ°›åœ', uniqueId: 'd3e2' },
                    { time: '11:30', title: 'åˆé¤ï¼šå°¾é“æ‹‰éºµ / å°é‡è²“', type: 'meal', desc: 'å“åšç•¶åœ°ç‰¹è‰²æ‹‰éºµæˆ–å’–å•¡å»³', uniqueId: 'd3e3' },
                    { time: '13:00', title: 'äº¤é€šï¼šåƒå…‰å¯ºçºœè»Š', type: 'transport', desc: 'ğŸ’° å–®ç¨‹ Â¥320 / ä¾†å› Â¥500', uniqueId: 'd3e4' },
                    { 
                        time: '13:30', 
                        title: 'å°¾é“æ–‡å­¸ä¹‹é“', 
                        type: 'spot',
                        uniqueId: 'd3e5',
                        items: [
                            { 
                                name: 'åƒå…‰å¯º', 
                                mapQuery: 'åƒå…‰å¯º',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š6:00 - 17:00',
                                details: 'ä¾å±±è€Œå»ºçš„å¤å¯ºï¼Œå…¶ä¸­çš„ã€Œèµ¤å ‚ã€èˆ‡å·¨å¤§çš„ã€Œç‰ä¹‹å²©ã€æ˜¯è±¡å¾µã€‚é€™è£¡è¦–é‡æ¥µä½³ï¼Œå¯ä»¥ä¿¯ç°å°¾é“æ°´é“èˆ‡ç€¨æˆ¶å…§æµ·çš„çµ•ç¾æ™¯è‰²ï¼Œä¹Ÿæ˜¯æˆ€äººçš„è–åœ°ã€‚',
                                uniqueId: 'd3e5i1'
                            },
                            { 
                                name: 'è²“ä¹‹ç´°é“', 
                                mapQuery: 'è²“ã®ç´°é“',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ’¡ å‚™è¨»ï¼šå°‹æ‰¾è—è¡“å®¶å‰µä½œçš„ã€Œç¦çŸ³è²“ã€',
                                details: 'ä¸€æ¢èœ¿èœ’çš„å¡é“å°å¾‘ï¼Œæ²¿é€”è—è‘—è¨±å¤šç”±è—è¡“å®¶åœ’å±±æ˜¥äºŒå‰µä½œçš„ã€Œç¦çŸ³è²“ã€ã€‚é€™è£¡å……æ»¿æ‡·èˆŠæ°›åœï¼Œé‚„æœ‰è¨±å¤šçœŸæ­£çš„è²“å’ªå‡ºæ²’ï¼Œæ˜¯è²“å¥´å¿…è¨ªçš„ç™‚ç™’æ™¯é»ã€‚',
                                uniqueId: 'd3e5i2'
                            },
                             { 
                                name: 'å°¾é“å¸‚ç«‹ç¾è¡“é¤¨', 
                                mapQuery: 'å°¾é“å¸‚ç«‹ç¾è¡“é¤¨',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šÂ¥300 (å¸¸è¨­å±•)\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š9:00 - 17:00 (é€±ä¸€ä¼‘é¤¨)',
                                details: 'ä½æ–¼åƒå…‰å¯ºå…¬åœ’å…§ï¼Œç”±å»ºç¯‰å¤§å¸«å®‰è—¤å¿ é›„è¨­è¨ˆæ”¹å»ºã€‚æœ€è‘—åçš„æ˜¯æ›¾ç¶“æœ‰å…©éš»è²“å’ªã€ŒKen & Goã€è©¦åœ–é—–å…¥ç¾è¡“é¤¨èˆ‡è­¦è¡›å°å³™çš„å¯æ„›ç•«é¢ï¼Œç´…éå…¨çƒã€‚',
                                uniqueId: 'd3e5i3'
                            }
                        ]
                    },
                    { time: '17:03', title: 'äº¤é€šï¼šå±±é™½æœ¬ç·š å°¾é“ â†’ ä¸‰åŸ', type: 'transport', desc: 'è»Šç¨‹ç´„15åˆ†é˜', uniqueId: 'd3e6' },
                    { 
                        time: '17:20', 
                        title: 'ä¸‰åŸåŸè·¡', 
                        type: 'spot',
                        uniqueId: 'd3e7',
                        items: [{ 
                            name: 'ä¸‰åŸåŸè·¡', 
                            mapQuery: 'ä¸‰åŸåŸè·¡',
                            logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ’¡ å‚™è¨»ï¼šå¤©å®ˆå°çŸ³å£èˆ‡è»Šç«™å…±æ§‹',
                            details: 'ç”±å°æ—©å·éš†æ™¯æ‰€å»ºï¼Œæ›¾ç¶“æ˜¯æµ®åœ¨æµ·ä¸Šçš„æ°´è»åŸã€‚ç¾åœ¨å¤©å®ˆå°çš„çŸ³å£éºè·¡å°±ç›´æ¥èˆ‡ä¸‰åŸè»Šç«™åˆç‚ºä¸€é«”ï¼Œæ˜¯å€‹éå¸¸ç¨ç‰¹çš„ã€Œè»Šç«™åŸã€ã€‚',
                            uniqueId: 'd3e7i1'
                        }]
                    },
                    { time: '17:30', title: 'æ™šé¤ï¼šå’Œé£Ÿå‡¦ ç™»å–œå°†', type: 'meal', desc: 'ä¸‰åŸç«™å‘¨é‚Šé¤å»³', uniqueId: 'd3e8' },
                    { time: '19:13', title: 'äº¤é€šï¼šJRå±±é™½æœ¬ç·š ä¸‰åŸ â†’ å»£å³¶', type: 'transport', desc: 'è¿”å›å»£å³¶', uniqueId: 'd3e9' },
                ]
            },
            {
                day: 4, dayLabel: 'D4', date: '12/8', location: 'å®®å³¶',
                events: [
                    { time: '09:00', title: 'äº¤é€šï¼šJR â†’ å®®å³¶å£', type: 'transport', desc: 'JRå±±é™½æœ¬ç·š', uniqueId: 'd4e1' },
                    { time: '09:20', title: 'äº¤é€šï¼šå®®å³¶æ¸¡è¼ª', type: 'transport', desc: 'ğŸ’° å–®ç¨‹ Â¥180 (JR æˆ– æ¾å¤§æ±½èˆ¹)', uniqueId: 'd4e2' },
                    { 
                        time: '10:00', 
                        title: 'å®®å³¶è‡ªç„¶èˆ‡æ­·å²', 
                        type: 'spot',
                        uniqueId: 'd4e3',
                        items: [
                            { 
                                name: 'ç´…è‘‰è°·å…¬åœ’', 
                                mapQuery: 'ç´…è‘‰è°·å…¬åœ’',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ’¡ å‚™è¨»ï¼šè³æ¥“ã€é‡ç”Ÿé¹¿ç¾¤å‡ºæ²’',
                                details: 'ä½æ–¼å½Œå±±è…³ä¸‹ï¼Œæ“æœ‰ç´„700æ£µæ¥“æ¨¹ã€‚ç§‹å¤©æ™‚æ»¿å±±ç«ç´…ï¼Œæ™¯è‰²å¦‚è©©å¦‚ç•«ï¼Œæ˜¯æ—¥æœ¬è‘—åçš„è³æ¥“å‹åœ°ï¼Œä¹Ÿæ˜¯å®®å³¶é¹¿ç¾¤å¸¸å‡ºæ²’çš„åœ°æ–¹ã€‚',
                                uniqueId: 'd4e3i1'
                            },
                            { 
                                name: 'ä¸–ç•Œè‡ªç„¶éºç”¢-å½Œå±±', 
                                mapQuery: 'å½Œå±±',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šçºœè»Šä¾†å› Â¥2000\nğŸ’¡ å‚™è¨»ï¼šåŒ…å«ä¸æ»…çš„ã€Œéˆç«å ‚ã€',
                                details: 'å®®å³¶çš„ä¸»å³°ï¼Œä¿ç•™äº†åŸå§‹æ£®æ—ã€‚å±±é ‚æœ‰ã€Œéˆç«å ‚ã€ï¼Œä¾›å¥‰è‘—å¼˜æ³•å¤§å¸«é»ç‡ƒå¾Œç‡ƒç‡’äº†1200å¹´ä¸æ»…çš„éˆç«ï¼Œæ“šèªªé€™ç«ä¹Ÿæ˜¯å’Œå¹³ç´€å¿µå…¬åœ’ã€Œå’Œå¹³ä¹‹ç‡ˆã€çš„ç«ç¨®ä¾†æºã€‚',
                                uniqueId: 'd4e3i2'
                            }
                        ]
                    },
                    { time: '12:00', title: 'åˆé¤ï¼šè‡ªå‚™ (å±±ä¸Š) / è¡¨åƒé“ç¾é£Ÿ', type: 'meal', desc: 'ç‰¡è £ã€ç©´å­é£¯ã€ç´…è‘‰é¥…é ­', uniqueId: 'd4e4' },
                    { time: '13:30', title: 'åš´å³¶ç¥ç¤¾è¡¨åƒé“å•†åº—è¡—', type: 'misc', desc: 'è³¼ç‰©ã€å¯„æ˜ä¿¡ç‰‡', uniqueId: 'd4e5' },
                    { 
                        time: '15:00', 
                        title: 'åš´å³¶ç¥ç¤¾å‘¨é‚Š', 
                        type: 'spot',
                        uniqueId: 'd4e6',
                        items: [
                            { 
                                name: 'åš´å³¶ç¥ç¤¾ & å¤§é³¥å±…', 
                                mapQuery: 'åš´å³¶ç¥ç¤¾',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šÂ¥300 (ç¥ç¤¾æœ¬é«”)\nğŸ’¡ å‚™è¨»ï¼šæ½®æ±æ™‚é–“è«‹äº‹å…ˆç¢ºèª',
                                details: 'å»ºæ–¼æµ·ä¸Šçš„ç¥ç¤¾ï¼Œæ“æœ‰1400å¹´æ­·å²ï¼Œä¹Ÿæ˜¯ä¸–ç•Œæ–‡åŒ–éºç”¢ã€‚æ¼²æ½®æ™‚å¤§é³¥å±…å½·å½¿æ¼‚æµ®åœ¨æµ·é¢ä¸Šï¼Œå¤¢å¹»ç„¡æ¯”ï¼›é€€æ½®æ™‚å‰‡å¯æ­¥è¡Œè‡³é³¥å±…ä¸‹æ–¹è§¸æ‘¸æŸ±è…³ã€‚',
                                uniqueId: 'd4e6i1'
                            },
                            { 
                                name: 'è±åœ‹ç¥ç¤¾åƒç–Šé–£', 
                                mapQuery: 'åƒç–Šé–£',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šÂ¥100\nğŸ•™ ç‡Ÿæ¥­æ™‚é–“ï¼š8:30 - 16:30',
                                details: 'è±è‡£ç§€å‰ç‚ºäº†ç¥­å¥ æˆ°æ­¿å°‡å£«è€Œå»ºçš„å¤§ç¶“å ‚ï¼Œå› é¢ç©å¯¬é”857ç–Šæ¦»æ¦»ç±³è€Œå¾—åã€‚é€™æ˜¯ä¸€åº§æœªå®Œæˆçš„å»ºç¯‰ï¼Œæ²’æœ‰å¤©èŠ±æ¿èˆ‡ç‰†å£ï¼Œé€šé¢¨æ¥µä½³ï¼Œå……æ»¿æ­·å²æ»„æ¡‘æ„Ÿã€‚',
                                uniqueId: 'd4e6i2'
                            },
                            { 
                                name: 'å¤§è–é™¢', 
                                mapQuery: 'å¤§è–é™¢',
                                logistics: 'ğŸ’° é–€ç¥¨ï¼šå…è²»\nğŸ’¡ å‚™è¨»ï¼šæœ‰ã€Œéç…§çªŸã€å…«åå…«æ‰€å·¡ç¦®',
                                details: 'å®®å³¶æ­·å²æœ€æ‚ ä¹…çš„å¯ºå»Ÿï¼Œèˆ‡å¼˜æ³•å¤§å¸«æ·µæºæ·±åšã€‚å¢ƒå…§æœ‰ã€Œéç…§çªŸã€ï¼Œå…§æœ‰å››åœ‹å…«åå…«è™•éˆå ´çš„ç ‚ï¼Œæ“šèªªèµ°ä¸€åœˆå°±èƒ½ç²å¾—éè·¯å·¡ç¦®çš„åŠŸå¾·ï¼Œé‚„æœ‰å¯æ„›çš„ã€Œæ„šç™¡è½èåœ°è—ã€ã€‚',
                                uniqueId: 'd4e6i3'
                            }
                        ]
                    },
                    { time: '18:00', title: 'äº¤é€šï¼šå®®å³¶æ¸¡è¼ªå›å»£å³¶', type: 'transport', desc: 'è¿”å›å»£å³¶è»Šç«™', uniqueId: 'd4e7' },
                ]
            },
            {
                day: 5, dayLabel: 'D5', date: '12/9', location: 'è¿”ç¨‹',
                events: [
                    { time: '06:30', title: 'Check-out / å»£å³¶æ–°å¹¹ç·šå£', type: 'hotel', desc: 'é€€æˆ¿å¾Œå‰å¾€å»£å³¶è»Šç«™æ–°å¹¹ç·šå£', uniqueId: 'd5e1' },
                    { time: '07:00', title: 'äº¤é€šï¼šæ©Ÿå ´å·´å£« â†’ å»£å³¶æ©Ÿå ´', type: 'transport', desc: 'ç´„45-50åˆ†é˜', uniqueId: 'd5e2' },
                    { time: '11:15', end: '13:10', title: 'èˆªç­ HIJ â†’ TPE', type: 'transport', desc: 'è¯èˆª CI113', uniqueId: 'd5e3' }
                ]
            }
        ];
        
        // è®Šæ•¸ç”¨æ–¼å„²å­˜ç•¶å‰ä½¿ç”¨çš„è¡Œç¨‹è³‡æ–™
        let currentItineraryData = [];
        // è®Šæ•¸ç”¨æ–¼å„²å­˜ç•¶å‰é¡¯ç¤ºçš„ Day Index
        let currentDayIndex = 0;

        // --- åˆå§‹åŒ–èˆ‡è³‡æ–™è¼‰å…¥ (é›¢ç·š LocalStorage) ---
        function loadItineraryData() {
            try {
                const storedData = localStorage.getItem('user_itinerary_edits');
                if (storedData) {
                    currentItineraryData = JSON.parse(storedData);
                    console.log('è¡Œç¨‹å·²å¾ LocalStorage è¼‰å…¥ã€‚');
                    // æª¢æŸ¥æ•¸æ“šçµæ§‹æ˜¯å¦ç›¸å®¹ï¼Œå¦‚æœä¸ç›¸å®¹å‰‡ä½¿ç”¨å‚™ä»½
                    if (!Array.isArray(currentItineraryData) || currentItineraryData.length !== originalItineraryData.length) {
                         currentItineraryData = JSON.parse(JSON.stringify(originalItineraryData));
                         console.log('LocalStorage è³‡æ–™çµæ§‹ç•°å¸¸ï¼Œå·²è¼‰å…¥åŸå§‹è³‡æ–™ã€‚');
                    }
                } else {
                    // å¦‚æœæ²’æœ‰å­˜å„²çš„æ•¸æ“šï¼Œå‰‡ä½¿ç”¨åŸå§‹æ•¸æ“š
                    currentItineraryData = JSON.parse(JSON.stringify(originalItineraryData));
                    console.log('è¼‰å…¥åŸå§‹è¡Œç¨‹è³‡æ–™ã€‚');
                }
            } catch (e) {
                console.error('LocalStorage è®€å–æˆ–è§£æéŒ¯èª¤ï¼Œä½¿ç”¨åŸå§‹è³‡æ–™:', e);
                currentItineraryData = JSON.parse(JSON.stringify(originalItineraryData));
            }
        }
        
        function saveItineraryData() {
             try {
                // åªå„²å­˜å¯¦éš›åœ¨ç”¨çš„æ•¸æ“š
                localStorage.setItem('user_itinerary_edits', JSON.stringify(currentItineraryData));
                console.log('è¡Œç¨‹ä¿®æ”¹å·²å­˜å…¥ LocalStorageã€‚');
            } catch (e) {
                console.error('LocalStorage å¯«å…¥éŒ¯èª¤:', e);
            }
        }

        // --- æ¨¡æ…‹è¦–çª—é€šç”¨åŠŸèƒ½ ---
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                 modal.classList.remove('is-open');
                 setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                 }, 300);
            }
        };


        // --- ç·¨è¼¯åŠŸèƒ½ (é•·æŒ‰/å³éµè§¸ç™¼) ---

        // æŸ¥æ‰¾äº‹ä»¶æˆ–å­é …ç›® by uniqueId
        function findEventByUniqueId(uniqueId) {
            for (let d = 0; d < currentItineraryData.length; d++) {
                const day = currentItineraryData[d];
                for (let e = 0; e < day.events.length; e++) {
                    const event = day.events[e];
                    if (event.uniqueId === uniqueId) {
                        return { dayIndex: d, eventIndex: e, event: event, isItem: false };
                    }
                    if (event.items) {
                        for (let i = 0; i < event.items.length; i++) {
                            const item = event.items[i];
                            if (item.uniqueId === uniqueId) {
                                return { dayIndex: d, eventIndex: e, itemIndex: i, item: item, isItem: true };
                            }
                        }
                    }
                }
            }
            return null;
        }

        // é¡¯ç¤ºç·¨è¼¯æ¨¡æ…‹è¦–çª— (é›¢ç·šå¯ç”¨)
        window.showEditModal = function(uniqueId, event) {
            // é˜»æ­¢é•·æŒ‰/å³éµèœå–®å½ˆå‡º
            event.preventDefault(); 
            event.stopPropagation();
            
            const found = findEventByUniqueId(uniqueId);
            if (!found) {
                console.error('æ‰¾ä¸åˆ° uniqueId:', uniqueId);
                return;
            }
            
            const data = found.isItem ? found.item : found.event;
            const descField = found.isItem ? data.details : data.desc; // æ™¯é»çš„è©³ç´°è³‡è¨Šæ˜¯ detailsï¼Œä¸€èˆ¬é …ç›®çš„è©³ç´°è³‡è¨Šæ˜¯ desc
            const timeField = found.isItem ? (found.event.time || '') : (data.time || ''); // å­é …ç›®ä¸ç·¨è¼¯æ™‚é–“

            // å¡«å……è¡¨å–®
            document.getElementById('edit-day-index').value = found.dayIndex;
            document.getElementById('edit-event-index').value = found.eventIndex;
            document.getElementById('edit-item-index').value = found.isItem ? found.itemIndex : -1; // -1 è¡¨ç¤ºä¸æ˜¯å­é …ç›®

            document.getElementById('edit-time').value = timeField;
            document.getElementById('edit-title').value = data.title || data.name;
            document.getElementById('edit-desc').value = descField || ''; 
            
            // æ ¹æ“šæ˜¯å¦ç‚ºæ™¯é»å­é …ç›®ï¼Œèª¿æ•´æ™‚é–“æ¬„ä½ç‹€æ…‹
            const timeInput = document.getElementById('edit-time');
            if (found.isItem) {
                timeInput.disabled = true;
                timeInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                timeInput.placeholder = 'æ™¯é»å­é …ç›®ä¸ç·¨è¼¯æ™‚é–“';
            } else {
                timeInput.disabled = false;
                timeInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                timeInput.placeholder = 'ä¾‹å¦‚: 10:00';
            }

            // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.add('is-open'); 
                document.body.style.overflow = 'hidden';
            });
        };

        // å„²å­˜ç·¨è¼¯ (é›¢ç·šå¯ç”¨)
        window.saveEdit = function(e) {
            e.preventDefault();

            const dayIndex = parseInt(document.getElementById('edit-day-index').value);
            const eventIndex = parseInt(document.getElementById('edit-event-index').value);
            const itemIndex = parseInt(document.getElementById('edit-item-index').value);

            const newTime = document.getElementById('edit-time').value.trim();
            const newTitle = document.getElementById('edit-title').value.trim();
            const newDesc = document.getElementById('edit-desc').value.trim();
            
            if (dayIndex >= 0 && eventIndex >= 0) {
                let target;
                if (itemIndex >= 0) {
                    // æ™¯é»å­é …ç›®
                    target = currentItineraryData[dayIndex].events[eventIndex].items[itemIndex];
                    target.name = newTitle; // æ›´æ–°åç¨±
                    target.details = newDesc; // æ›´æ–°æ™¯é»ä»‹ç´¹
                } else {
                    // ä¸€èˆ¬äº‹ä»¶
                    target = currentItineraryData[dayIndex].events[eventIndex];
                    target.time = newTime;
                    target.title = newTitle;
                    target.desc = newDesc; // æ›´æ–°å‚™è¨»
                }
                
                // å„²å­˜åˆ° LocalStorage
                saveItineraryData();
                
                // é‡æ–°æ¸²æŸ“ç•¶å‰é é¢
                renderItinerary(currentDayIndex);
                
                // é—œé–‰ Modal
                closeModal('edit-modal');
            } else {
                console.error('ç·¨è¼¯ç´¢å¼•éŒ¯èª¤');
            }
        };

        // --- è¡Œç¨‹æ¸²æŸ“èˆ‡äº‹ä»¶ç¶å®š ---
        
        // ä¸» Tab åˆ‡æ› (é›¢ç·šå¯ç”¨)
        window.switchMainTab = function(tabId) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const navMap = { 'itinerary': 0, 'info': 1, 'prep': 2, 'guide': 3 };
            document.querySelectorAll('.nav-btn')[navMap[tabId]].classList.add('active');
            
            if (tabId === 'itinerary') {
                // å¦‚æœåˆ‡å›è¡Œç¨‹ï¼Œé‡æ–°æ¸²æŸ“ç•¶å‰æ—¥æœŸ
                renderItinerary(currentDayIndex);
            } else {
                window.scrollTo(0,0);
            }
        };

        // é–‹å•Ÿ Google Map (éœ€è¦ç¶²è·¯)
        window.openMap = function(query) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        };

        // é¡¯ç¤ºæ™¯é»ä»‹ç´¹å½ˆçª— (é›¢ç·šå¯ç”¨)
        window.showDetailsModal = function(encodedDetails, title) {
            try {
                const details = decodeURIComponent(escape(atob(encodedDetails)));
                let formattedDetails = details.replace(/\n/g, '<br>');
                formattedDetails = formattedDetails.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
                formattedDetails = formattedDetails.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedDetails = formattedDetails.replace(/---/g, '<hr class="my-4 border-gray-200">');

                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = formattedDetails;
                
                const modal = document.getElementById('details-modal');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.add('is-open'); 
                    document.body.style.overflow = 'hidden';
                });
            } catch (e) {
                console.error("Error decoding or rendering modal content:", e);
            }
        };

        // æ¸²æŸ“è¡Œç¨‹ (é›¢ç·šå¯ç”¨)
        function renderItinerary(dayIndex) {
            currentDayIndex = dayIndex; // æ›´æ–°ç•¶å‰æ—¥æœŸç´¢å¼•
            const container = document.getElementById('day-content-container');
            const data = currentItineraryData[dayIndex];
            
            // Render Tabs
            const tabContainer = document.getElementById('day-tabs-container');
            tabContainer.innerHTML = currentItineraryData.map((d, idx) => `
                <button onclick="renderItinerary(${idx})" 
                    class="day-tab-btn flex-1 aspect-[1/0.9] rounded-xl flex flex-col items-center justify-center shadow-sm
                           ${idx === dayIndex ? 'active' : 'inactive'}">
                    <span class="text-xs font-medium mb-1 opacity-80">${d.date}</span>
                    <span class="text-xl font-bold tracking-tight">${d.dayLabel}</span>
                </button>
            `).join('');

            // Render Events
            let html = `<div class="mb-5 text-sm font-medium text-gray-500 pl-2 flex items-center"><span class="mr-1">ğŸ“</span> ${data.location}</div>`;
            
            html += data.events.map((event, eventIndex) => {
                let dotColor = 'bg-gray-300';
                if (event.type === 'transport') { dotColor = 'bg-blue-400'; }
                else if (event.type === 'meal') { dotColor = 'bg-orange-400'; }
                else if (event.type === 'spot') { dotColor = 'bg-red-500'; }
                else if (event.type === 'hotel') { dotColor = 'bg-indigo-400'; }

                let contentWrapperHtml = '';
                
                if (event.type === 'spot' && event.items) {
                    // æ™¯é»äº‹ä»¶ç¾¤çµ„ (ç„¡æ³•ç›´æ¥ç·¨è¼¯ç¾¤çµ„æ¨™é¡Œï¼Œåªèƒ½ç·¨è¼¯å­é …ç›®)
                    contentWrapperHtml = `
                        <div class="mb-2 text-xs font-mono font-bold text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded">${event.time}</div>
                        <div class="space-y-4">
                            ${event.items.map((item, itemIndex) => {
                                // æ™¯é»å­é …ç›® - ç¶å®šé•·æŒ‰/å³éµäº‹ä»¶
                                const encodedDetails = btoa(unescape(encodeURIComponent(item.details)));
                                const logisticsHtml = item.logistics ? `<div class="logistics-list">${item.logistics}</div>` : '';

                                return `
                                <div class="bg-white rounded-xl p-4 flat-card border border-gray-100 shadow-sm relative overflow-hidden editable-card"
                                     oncontextmenu="showEditModal('${item.uniqueId}', event)"
                                     ontouchstart="handleTouchStart(event, '${item.uniqueId}')"
                                     ontouchend="handleTouchEnd()"
                                     onmousedown="handleMouseDown(event, '${item.uniqueId}')"
                                     onmouseup="handleMouseUp()"
                                >
                                    <div class="relative z-10">
                                        <div class="font-bold text-gray-800 text-lg mb-2 flex justify-between items-start">
                                            ${item.name}
                                            <button onclick="openMap('${item.mapQuery || item.name}')" class="text-gray-400 hover:text-blue-500 p-1.5 rounded-full transition" aria-label="Open Map">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                        
                                        ${logisticsHtml}

                                        <button onclick="showDetailsModal('${encodedDetails}', '${item.name}')" 
                                            class="mt-3 text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-full text-xs font-bold transition flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                            è©³ç´°ä»‹ç´¹
                                        </button>
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                    `;
                } else {
                    // ä¸€èˆ¬å–®ä¸€äº‹ä»¶ - ç¶å®šé•·æŒ‰/å³éµäº‹ä»¶
                    const descHtml = event.desc ? `<div class="logistics-list">${event.desc}</div>` : '';

                    contentWrapperHtml = `
                        <div class="flat-card p-4 relative bg-white editable-card"
                             oncontextmenu="showEditModal('${event.uniqueId}', event)"
                             ontouchstart="handleTouchStart(event, '${event.uniqueId}')"
                             ontouchend="handleTouchEnd()"
                             onmousedown="handleMouseDown(event, '${event.uniqueId}')"
                             onmouseup="handleMouseUp()"
                        >
                            <div class="text-xs font-mono font-bold text-gray-500 mb-1">${event.time}</div>
                            <div class="font-bold text-gray-800 text-base">${event.title}</div>
                            ${descHtml}
                        </div>
                    `;
                }

                return `
                    <div class="timeline-item relative pl-6 pb-8 last:pb-0">
                        <div class="timeline-line"></div>
                        <!-- åœ“é» -->
                        <div class="absolute left-[2px] top-[28px] w-2.5 h-2.5 rounded-full ${dotColor} border-2 border-white box-content z-10 shadow-sm"></div>
                        
                        <!-- å…§å®¹æœ¬é«” -->
                        <div class="pl-6">
                            ${contentWrapperHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }
        window.renderItinerary = renderItinerary;

        // --- è§¸æ‘¸/æ»‘é¼ äº‹ä»¶è™•ç† (ç”¨æ–¼å¯¦ç¾é•·æŒ‰/å³éµç·¨è¼¯) ---
        let touchTimer = null;
        let isMoving = false; // ç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºæ»‘å‹•ï¼Œè€Œä¸æ˜¯é»æ“Š/é•·æŒ‰

        // è§¸æ‘¸é–‹å§‹ (é•·æŒ‰)
        window.handleTouchStart = function(event, uniqueId) {
            // å…è¨±å–®é»è§¸æ‘¸
            if (event.touches.length > 1) return;
            isMoving = false;
            
            // è¨­ç½®è¨ˆæ™‚å™¨ï¼Œå¦‚æœæŒçºŒæŒ‰ä¸‹ 800msï¼Œå‰‡è§¸ç™¼ç·¨è¼¯
            touchTimer = setTimeout(() => {
                // å¦‚æœæ²’æœ‰æ»‘å‹•ï¼Œæ‰è§¸ç™¼ç·¨è¼¯
                if (!isMoving) {
                    showEditModal(uniqueId, event);
                }
            }, 800); 

            // ç›£è½ç§»å‹•äº‹ä»¶ (å¦‚æœæ‰‹æŒ‡ç§»å‹•è¶…éä¸€å®šè·é›¢ï¼Œå‰‡å–æ¶ˆé•·æŒ‰)
            event.currentTarget.addEventListener('touchmove', handleTouchMove);
        };
        
        // è§¸æ‘¸ç§»å‹•
        function handleTouchMove(event) {
            // å¦‚æœè§¸æ‘¸é»ç§»å‹•è¶…éä¸€å®šè·é›¢ï¼Œè¦–ç‚ºæ»‘å‹•
            if (Math.abs(event.touches[0].clientX - event.currentTarget.getBoundingClientRect().left) > 10 ||
                Math.abs(event.touches[0].clientY - event.currentTarget.getBoundingClientRect().top) > 10) {
                isMoving = true;
            }
            clearTimeout(touchTimer);
        }

        // è§¸æ‘¸çµæŸ
        window.handleTouchEnd = function() {
            clearTimeout(touchTimer);
            // ç§»é™¤ç§»å‹•ç›£è½å™¨
            document.querySelectorAll('.editable-card').forEach(card => card.removeEventListener('touchmove', handleTouchMove));
        };
        
        // æ»‘é¼ æŒ‰ä¸‹ (ç”¨æ–¼é›»è…¦/æ»‘é¼ å³éµ)
        window.handleMouseDown = function(event, uniqueId) {
            // 0: å·¦éµ, 2: å³éµ
            if (event.button === 0) {
                // å·¦éµæ¨¡æ“¬é•·æŒ‰
                isMoving = false;
                touchTimer = setTimeout(() => {
                    if (!isMoving) {
                        showEditModal(uniqueId, event);
                    }
                }, 800);
            }
        };

        // æ»‘é¼ æŠ¬èµ·
        window.handleMouseUp = function() {
             clearTimeout(touchTimer);
        };
        
        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadItineraryData();
            // é è¨­é¡¯ç¤º Day 1
            renderItinerary(0);
        };

    </script>
</body>
</html>
